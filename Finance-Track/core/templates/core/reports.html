{% extends 'core/base.html' %}

{% block title %}Reports - Finance Tracker{% endblock %}

{% block content %}
<h2>Financial Reports & Analytics</h2>

<!-- Filters Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Report Filters</span>
        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
            Toggle Filters
        </button>
    </div>
    <div class="collapse show" id="filtersCollapse">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start_date" name="start_date" value="{{ current_start_date }}">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end_date" name="end_date" value="{{ current_end_date }}">
                </div>
                <div class="col-md-3">
                    <label for="transaction_type" class="form-label">Transaction Type</label>
                    <select class="form-select" id="transaction_type" name="transaction_type">
                        <option value="all" {% if not current_transaction_type or current_transaction_type == 'all' %}selected{% endif %}>All Types</option>
                        <option value="income" {% if current_transaction_type == 'income' %}selected{% endif %}>Income</option>
                        <option value="expense" {% if current_transaction_type == 'expense' %}selected{% endif %}>Expense</option>
                        <option value="transfer" {% if current_transaction_type == 'transfer' %}selected{% endif %}>Transfer</option>
                        <option value="owners_equity" {% if current_transaction_type == 'owners_equity' %}selected{% endif %}>Owners Equity</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" name="category">
                        <option value="all" data-type="all">All Categories</option>
                        {% for category in all_categories %}
                            <option value="{{ category.id }}" data-type="{{ category.category_type }}" {% if current_category == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3" id="subcategory-filter" style="{% if current_transaction_type != 'expense' %}display: none;{% endif %}">
                    <label for="subcategory" class="form-label">Subcategory</label>
                    <select class="form-select" id="subcategory" name="subcategory">
                        <option value="all">All Subcategories</option>
                        {% for subcategory in all_subcategories %}
                            <option value="{{ subcategory.id }}" data-parent="{{ subcategory.parent.id }}" {% if current_subcategory == subcategory.id %}selected{% endif %}>
                                {{ subcategory.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="account" class="form-label">Account</label>
                    <select class="form-select" id="account" name="account">
                        <option value="all">All Accounts</option>
                        {% for account in all_accounts %}
                            <option value="{{ account.id }}" {% if current_account == account.id %}selected{% endif %}>
                                {{ account.name }} ({{ account.currency.code }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="team" class="form-label">Team</label>
                    <select class="form-select" id="team" name="team">
                        <option value="all">All Teams</option>
                        {% for team in all_teams %}
                            <option value="{{ team.id }}" {% if current_team == team.id %}selected{% endif %}>
                                {{ team.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
                    <a href="{% url 'reports' %}" class="btn btn-outline-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h5>Total Income</h5>
                <h3>{{ total_income|floatformat:2 }} PKR</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h5>Total Expense</h5>
                <h3>{{ total_expense|floatformat:2 }} PKR</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h5>Total Transfers</h5>
                <h3>{{ total_transfers|floatformat:2 }} PKR</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card {% if net_amount >= 0 %}bg-success{% else %}bg-warning{% endif %} text-white">
            <div class="card-body text-center">
                <h5>Net Amount</h5>
                <h3>{{ net_amount|floatformat:2 }} PKR</h3>
                <small>{% if net_amount >= 0 %}Profit{% else %}Loss{% endif %}</small>
            </div>
        </div>
    </div>
</div>

<!-- Consolidated Report Based on Filters -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>ðŸ“Š Financial Report (Based on Applied Filters)</span>
        {% if consolidated_breakdown %}
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success btn-sm" onclick="downloadReport('csv')">
                ðŸ“„ Download CSV
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="downloadReport('excel')">
                ðŸ“Š Download Excel
            </button>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        {% if consolidated_breakdown %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Transaction Type</th>
                            <th>Category</th>
                            <th>Subcategory</th>
                            <th>Account</th>
                            <th>Counter Party</th>
                            <th>Team</th>
                            <th>Currency</th>
                            <th>Exchange Rate</th>
                            <th>Original Amount</th>
                            <th>PKR Amount</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in consolidated_breakdown %}
                        <tr>
                            <td>{{ item.transaction_date|date:"M d, Y" }}</td>
                            <td>
                                <span class="badge {% if item.transaction_type == 'income' %}bg-success{% elif item.transaction_type == 'expense' %}bg-danger{% else %}bg-info{% endif %}">
                                    {{ item.transaction_type|title }}
                                </span>
                            </td>
                            <td>
                                {% if item.category %}
                                    {% if item.category.parent %}
                                        {{ item.category.parent.name }}
                                    {% else %}
                                        {{ item.category.name }}
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if item.category and item.category.parent %}
                                    {{ item.category.name }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ item.account.name }}</td>
                            <td>{{ item.counter_party_account.name|default:"-" }}</td>
                            <td>{{ item.team.name|default:"-" }}</td>
                            <td>{{ item.currency.code }}</td>
                            <td>
                                {% if item.exchange_rate_to_pkr and item.exchange_rate_to_pkr != 1.0000 %}
                                    1 {{ item.currency.code }} = {{ item.exchange_rate_to_pkr|floatformat:4 }} PKR
                                {% elif item.currency.code == 'PKR' or item.exchange_rate_to_pkr == 1.0000 %}
                                    -
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ item.amount|floatformat:2 }} {{ item.currency.code }}</td>
                            <td>{{ item.amount_pkr|floatformat:2 }} PKR</td>
                            <td>{{ item.description|truncatechars:50 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if consolidated_breakdown|length > 10 %}
                <div class="mt-3">
                    <small class="text-muted">Showing {{ consolidated_breakdown|length }} results</small>
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-4">
                <h5 class="text-muted">No data available for selected filters</h5>
                <p class="text-muted">Try adjusting your filter criteria to view reports.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Category Filtering JavaScript -->
<script>
// Filter categories and subcategories based on transaction type
function filterCategories() {
    const transactionTypeSelect = document.getElementById('transaction_type');
    const categorySelect = document.getElementById('category');
    const subcategoryFilter = document.getElementById('subcategory-filter');
    const subcategorySelect = document.getElementById('subcategory');
    const selectedType = transactionTypeSelect.value;
    
    // Show/hide subcategory filter based on transaction type
    if (selectedType === 'expense') {
        subcategoryFilter.style.display = 'block';
    } else {
        subcategoryFilter.style.display = 'none';
        subcategorySelect.value = 'all'; // Reset subcategory when hidden
    }
    
    // Get all category options
    const categoryOptions = categorySelect.querySelectorAll('option');
    
    categoryOptions.forEach(option => {
        const categoryType = option.getAttribute('data-type');
        
        if (selectedType === 'all' || categoryType === 'all' || categoryType === selectedType) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset category selection if current selection is not visible
    const currentOption = categorySelect.querySelector(`option[value="${categorySelect.value}"]`);
    if (currentOption && currentOption.style.display === 'none') {
        categorySelect.value = 'all';
    }
    
    // Filter subcategories when category changes
    filterSubcategories();
}

// Filter subcategories based on selected category
function filterSubcategories() {
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory');
    const selectedCategory = categorySelect.value;
    
    // Get all subcategory options
    const subcategoryOptions = subcategorySelect.querySelectorAll('option');
    
    subcategoryOptions.forEach(option => {
        const parentId = option.getAttribute('data-parent');
        
        if (option.value === 'all' || selectedCategory === 'all' || parentId === selectedCategory) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset subcategory selection if current selection is not visible
    const currentOption = subcategorySelect.querySelector(`option[value="${subcategorySelect.value}"]`);
    if (currentOption && currentOption.style.display === 'none') {
        subcategorySelect.value = 'all';
    }
}

// Add event listener when page loads
document.addEventListener('DOMContentLoaded', function() {
    const transactionTypeSelect = document.getElementById('transaction_type');
    const categorySelect = document.getElementById('category');
    
    transactionTypeSelect.addEventListener('change', filterCategories);
    categorySelect.addEventListener('change', filterSubcategories);
    
    // Filter on page load in case there's a pre-selected transaction type
    filterCategories();
});
</script>

<!-- Download JavaScript -->
<script>
function downloadReport(format) {
    // Get current filter parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Add format parameter
    urlParams.set('format', format);
    urlParams.set('download', 'true');
    
    // Create download URL
    const downloadUrl = '{% url "reports" %}?' + urlParams.toString();
    
    // Create temporary link and click it
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = `financial_report_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'csv'}`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

{% endblock %}
